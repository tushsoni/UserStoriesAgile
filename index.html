<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Story Manager Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #5d5dff;
            --secondary-color: #8c7ae6;
            --background-color: #f0f4f8;
            --card-background: #ffffff;
            --text-color: #2c3e50;
            --subtle-text: #7f8c8d;
            --border-color: #e6e6e6;
            --kanban-bg: #e5e9ec;

            --high-priority: #e74c3c;
            --medium-priority: #f39c12;
            --low-priority: #2ecc71;
            --critical-priority: #c0392b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 40px 0 30px;
        }

        .header h1 {
            font-size: 2.8rem;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--subtle-text);
        }

        .card {
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            padding: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        @media (min-width: 992px) {
            .grid-layout {
                grid-template-columns: 1fr 2fr;
            }
        }

        h2 {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            background-color: var(--background-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 93, 255, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background-color: #4949e2;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background-color: #7a68c0;
        }

        .btn-danger {
            background-color: var(--high-priority);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background-color: #d62c1e;
        }

        .stories-section {
            margin-top: 30px;
        }

        .filter-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--subtle-text);
        }
        
        /* Kanban Board Styles */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            align-items: flex-start;
        }

        .kanban-column {
            background-color: var(--kanban-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            min-height: 300px;
        }

        .kanban-column-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .kanban-column-count {
            font-size: 0.9rem;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 4px 8px;
            border-radius: 50%;
            font-weight: bold;
        }

        .story-card {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            cursor: grab;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid var(--border-color);
        }

        .story-card:active {
            cursor: grabbing;
        }

        .story-card.dragging {
            opacity: 0.5;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        .story-card.priority-low {
            border-left-color: var(--low-priority);
        }

        .story-card.priority-medium {
            border-left-color: var(--medium-priority);
        }

        .story-card.priority-high {
            border-left-color: var(--high-priority);
        }

        .story-card.priority-critical {
            border-left-color: var(--critical-priority);
        }

        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .story-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-right: 10px;
        }

        .story-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .meta-badge {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .badge-priority {
            color: white;
        }

        .badge-priority.low {
            background-color: var(--low-priority);
        }

        .badge-priority.medium {
            background-color: var(--medium-priority);
        }

        .badge-priority.high {
            background-color: var(--high-priority);
        }

        .badge-priority.critical {
            background-color: var(--critical-priority);
        }

        .badge-points {
            background-color: #f0f4f8;
            color: var(--text-color);
        }

        .story-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--subtle-text);
            margin-bottom: 15px;
        }

        .story-text strong {
            color: var(--text-color);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            max-width: 600px;
        }
        
        .modal-details h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        .modal-details p {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .modal-details p strong {
            color: var(--subtle-text);
            font-weight: 500;
            display: block;
            margin-bottom: 5px;
        }

        .close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--subtle-text);
        }

        .empty-state h3 {
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--subtle-text);
            margin-top: 5px;
        }

    </style>
</head>
<body>

<div class="container">
    <header class="header">
        <h1>🚀 User Story Manager Pro</h1>
        <p>A simple and enhanced tool for agile teams.</p>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="totalStories">0</div>
            <div class="stat-label">Total Stories</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalPoints">0</div>
            <div class="stat-label">Story Points</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="totalEpics">0</div>
            <div class="stat-label">Active Epics</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="avgPoints">0</div>
            <div class="stat-label">Avg. Points</div>
        </div>
    </div>

    <div class="grid-layout">
        <div class="card">
            <h2>✍️ New Story</h2>
            <form id="storyForm">
                <div class="form-group">
                    <label for="title">Story Title</label>
                    <input type="text" id="title" required placeholder="Enter a descriptive title">
                </div>
                <div class="form-group">
                    <label for="userType">As a...</label>
                    <input type="text" id="userType" required placeholder="e.g., customer, developer">
                </div>
                <div class="form-group">
                    <label for="action">I want to...</label>
                    <textarea id="action" required placeholder="Describe the user's goal"></textarea>
                </div>
                <div class="form-group">
                    <label for="benefit">So that...</label>
                    <textarea id="benefit" required placeholder="Describe the value or benefit"></textarea>
                </div>
                <div class="form-group">
                    <label for="priority">Priority</label>
                    <select id="priority">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="storyPoints">Story Points</label>
                    <input type="number" id="storyPoints" min="1" max="100" value="1">
                </div>
                <div class="form-group">
                    <label for="epic">Epic (optional)</label>
                    <input type="text" id="epic" placeholder="e.g., User Management, Checkout">
                </div>
                <button type="submit" class="btn btn-primary">Create Story</button>
            </form>
            <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                <button class="btn btn-secondary" onclick="loadSampleData()">Load Sample Stories</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" onclick="exportToJSON()" style="width: 100%;">Export JSON</button>
                    <button class="btn" onclick="exportToCSV()" style="width: 100%;">Export CSV</button>
                </div>
                <button class="btn btn-danger" onclick="clearAllStories()">Clear All Stories</button>
            </div>
        </div>

        <div class="card stories-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2>📋 Stories</h2>
            </div>
            
            <div class="filter-actions">
                <div class="filter-group">
                    <label for="priorityFilter">Priority</label>
                    <select id="priorityFilter" onchange="filterStories()">
                        <option value="">All</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="epicFilter">Epic</label>
                    <select id="epicFilter" onchange="filterStories()">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="filter-group" style="flex-grow: 1;">
                    <label for="searchInput">Search</label>
                    <input type="text" id="searchInput" placeholder="Search stories..." onkeyup="filterStories()">
                </div>
            </div>
            
            <div id="kanbanBoard" class="kanban-board">
                <div id="backlogColumn" class="kanban-column" ondrop="drop(event, 'Backlog')" ondragover="allowDrop(event)">
                    <div class="kanban-column-header">
                        Backlog <span id="backlogCount" class="kanban-column-count">0</span>
                    </div>
                </div>
                <div id="inProgressColumn" class="kanban-column" ondrop="drop(event, 'In Progress')" ondragover="allowDrop(event)">
                    <div class="kanban-column-header">
                        In Progress <span id="inProgressCount" class="kanban-column-count">0</span>
                    </div>
                </div>
                <div id="doneColumn" class="kanban-column" ondrop="drop(event, 'Done')" ondragover="allowDrop(event)">
                    <div class="kanban-column-header">
                        Done <span id="doneCount" class="kanban-column-count">0</span>
                    </div>
                </div>
            </div>
            
            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>No stories found</h3>
                <p>Start by creating a new story or loading sample data.</p>
            </div>
        </div>
    </div>
</div>

<div id="detailsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeDetailsModal()">&times;</span>
        <div id="modalDetails" class="modal-details"></div>
    </div>
</div>

<script>
    let userStories = [];
    let storyIdCounter = 1;

    const priorityClasses = {
        'Low': 'low',
        'Medium': 'medium',
        'High': 'high',
        'Critical': 'critical'
    };
    
    // Drag and Drop functions
    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev, newStatus) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");
        const storyCard = document.getElementById(data);
        
        // Find the right drop target (the column, not a card inside it)
        let dropTarget = ev.target;
        while (dropTarget && !dropTarget.classList.contains('kanban-column')) {
            dropTarget = dropTarget.parentElement;
        }
        
        if (dropTarget) {
            dropTarget.appendChild(storyCard);
            
            // Update the story status in our data model
            const story = userStories.find(s => s.id === storyCard.id);
            if (story) {
                story.status = newStatus;
                saveAndRender();
            }
        }
    }

    function generateId() {
        const timestamp = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
        return `US-${timestamp}-${storyIdCounter++}`;
    }

    function createUserStory(title, userType, action, benefit, priority = 'Medium', storyPoints = 1, epic = '') {
        const story = {
            id: generateId(),
            title,
            userType,
            action,
            benefit,
            priority,
            storyPoints: parseInt(storyPoints),
            epic,
            createdDate: new Date(),
            status: 'Backlog',
            acceptanceCriteria: []
        };
        userStories.push(story);
        saveAndRender();
        return story;
    }
    
    function createStoryCard(story) {
        const card = document.createElement('div');
        card.className = `story-card priority-${priorityClasses[story.priority]}`;
        card.id = story.id;
        card.draggable = true;
        card.ondragstart = drag;
        card.onclick = () => openDetailsModal(story.id);

        card.innerHTML = `
            <div class="story-header">
                <div class="story-title">${story.title}</div>
            </div>
            <div class="story-meta">
                <span class="meta-badge badge-priority ${priorityClasses[story.priority]}">${story.priority}</span>
                <span class="meta-badge badge-points">${story.storyPoints} pts</span>
                ${story.epic ? `<span class="meta-badge badge-points">${story.epic}</span>` : ''}
            </div>
        `;
        return card;
    }

    document.getElementById('storyForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = e.target;
        const title = form.title.value;
        const userType = form.userType.value;
        const action = form.action.value;
        const benefit = form.benefit.value;
        const priority = form.priority.value;
        const storyPoints = form.storyPoints.value;
        const epic = form.epic.value;
        createUserStory(title, userType, action, benefit, priority, storyPoints, epic);
        form.reset();
        form.priority.value = 'Medium';
        form.storyPoints.value = 1;
        showToast('Story created successfully!');
    });
    
    function displayStories(stories = userStories) {
        const backlogColumn = document.getElementById('backlogColumn');
        const inProgressColumn = document.getElementById('inProgressColumn');
        const doneColumn = document.getElementById('doneColumn');

        backlogColumn.innerHTML = `<div class="kanban-column-header">Backlog <span id="backlogCount" class="kanban-column-count">0</span></div>`;
        inProgressColumn.innerHTML = `<div class="kanban-column-header">In Progress <span id="inProgressCount" class="kanban-column-count">0</span></div>`;
        doneColumn.innerHTML = `<div class="kanban-column-header">Done <span id="doneCount" class="kanban-column-count">0</span></div>`;

        let backlogCount = 0;
        let inProgressCount = 0;
        let doneCount = 0;

        stories.forEach(story => {
            const card = createStoryCard(story);
            if (story.status === 'Backlog') {
                backlogColumn.appendChild(card);
                backlogCount++;
            } else if (story.status === 'In Progress') {
                inProgressColumn.appendChild(card);
                inProgressCount++;
            } else if (story.status === 'Done') {
                doneColumn.appendChild(card);
                doneCount++;
            }
        });

        document.getElementById('backlogCount').textContent = backlogCount;
        document.getElementById('inProgressCount').textContent = inProgressCount;
        document.getElementById('doneCount').textContent = doneCount;
        
        const emptyState = document.getElementById('emptyState');
        if (stories.length === 0) {
            emptyState.style.display = 'block';
            document.getElementById('kanbanBoard').style.display = 'none';
        } else {
            emptyState.style.display = 'none';
            document.getElementById('kanbanBoard').style.display = 'grid';
        }
    }

    function updateStats() {
        const totalStories = userStories.length;
        const totalPoints = userStories.reduce((sum, story) => sum + story.storyPoints, 0);
        const uniqueEpics = new Set(userStories.filter(s => s.epic).map(s => s.epic)).size;
        const avgPoints = totalStories > 0 ? (totalPoints / totalStories).toFixed(1) : 0;
        
        document.getElementById('totalStories').textContent = totalStories;
        document.getElementById('totalPoints').textContent = totalPoints;
        document.getElementById('totalEpics').textContent = uniqueEpics;
        document.getElementById('avgPoints').textContent = avgPoints;
    }

    function updateFilters() {
        const epicFilter = document.getElementById('epicFilter');
        const uniqueEpics = [...new Set(userStories.filter(s => s.epic).map(s => s.epic))];
        epicFilter.innerHTML = '<option value="">All</option>' + uniqueEpics.map(epic => `<option value="${epic}">${epic}</option>`).join('');
    }

    function filterStories() {
        const priorityFilter = document.getElementById('priorityFilter').value;
        const epicFilter = document.getElementById('epicFilter').value;
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        
        let filtered = userStories;
        
        if (priorityFilter) {
            filtered = filtered.filter(story => story.priority === priorityFilter);
        }
        
        if (epicFilter) {
            filtered = filtered.filter(story => story.epic === epicFilter);
        }
        
        if (searchInput) {
            filtered = filtered.filter(story => 
                story.title.toLowerCase().includes(searchInput) ||
                story.userType.toLowerCase().includes(searchInput) ||
                story.action.toLowerCase().includes(searchInput) ||
                story.benefit.toLowerCase().includes(searchInput) ||
                story.epic.toLowerCase().includes(searchInput)
            );
        }
        
        displayStories(filtered);
    }
    
    function openDetailsModal(storyId) {
        const story = userStories.find(s => s.id === storyId);
        if (!story) return;

        const modalDetails = document.getElementById('modalDetails');
        modalDetails.innerHTML = `
            <h2>${story.title}</h2>
            <p class="story-text">As a <strong>${story.userType}</strong>, I want to <strong>${story.action}</strong> so that <strong>${story.benefit}</strong>.</p>
            <div class="story-meta" style="margin-bottom: 20px;">
                <span class="meta-badge badge-priority ${priorityClasses[story.priority]}">${story.priority}</span>
                <span class="meta-badge badge-points">${story.storyPoints} pts</span>
                ${story.epic ? `<span class="meta-badge badge-points">${story.epic}</span>` : ''}
            </div>
            ${story.acceptanceCriteria.length > 0 ? `
                <div class="acceptance-criteria">
                    <h3>Acceptance Criteria</h3>
                    <ul class="criteria-list" style="list-style-type: none; padding-left: 0;">
                        ${story.acceptanceCriteria.map(criteria => `<li style="margin-bottom: 5px; color: var(--text-color);">${criteria}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="editStory('${story.id}')">Edit Story</button>
                <button class="btn btn-danger" onclick="deleteStory('${story.id}')">Delete Story</button>
            </div>
        `;

        document.getElementById('detailsModal').style.display = 'block';
    }

    function closeDetailsModal() {
        document.getElementById('detailsModal').style.display = 'none';
    }
    
    // Placeholder edit and delete functions for the modal
    function editStory(storyId) {
        showToast('Edit feature coming soon!');
        // You would implement a full edit form here
    }

    function deleteStory(storyId) {
        if (confirm('Are you sure you want to delete this story?')) {
            userStories = userStories.filter(story => story.id !== storyId);
            closeDetailsModal();
            saveAndRender();
            showToast('Story deleted!');
        }
    }

    function loadSampleData() {
        const sampleStories = [
            { id: generateId(), title: "User Registration", userType: "new customer", action: "create an account with email and password", benefit: "I can save my preferences and track my orders", priority: "High", storyPoints: 3, epic: "User Management", status: "Backlog", createdDate: new Date() },
            { id: generateId(), title: "Product Search", userType: "customer", action: "search for products by name or category", benefit: "I can quickly find what I'm looking for", priority: "High", storyPoints: 5, epic: "Product Catalog", status: "Backlog", createdDate: new Date() },
            { id: generateId(), title: "Shopping Cart", userType: "customer", action: "add items to my cart and modify quantities", benefit: "I can review my selection before purchasing", priority: "Critical", storyPoints: 8, epic: "Shopping Experience", status: "In Progress", createdDate: new Date() },
            { id: generateId(), title: "Payment Processing", userType: "customer", action: "securely pay for my order using credit card or PayPal", benefit: "I can complete my purchase safely", priority: "Critical", storyPoints: 13, epic: "Checkout Process", status: "In Progress", createdDate: new Date() },
            { id: generateId(), title: "Order Tracking", userType: "customer", action: "track the status of my order", benefit: "I know when to expect my delivery", priority: "Medium", storyPoints: 5, epic: "Order Management", status: "Done", createdDate: new Date() }
        ];
        userStories = sampleStories;
        saveAndRender();
        showToast('Sample data loaded!');
    }

    function clearAllStories() {
        if (confirm('Are you sure you want to delete all stories? This action cannot be undone.')) {
            userStories = [];
            storyIdCounter = 1;
            saveAndRender();
            showToast('All stories cleared!');
        }
    }
    
    function exportToJSON() {
        const dataStr = JSON.stringify(userStories, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `user-stories-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
    }
    
    function exportToCSV() {
        const headers = ['ID', 'Title', 'User Story', 'Priority', 'Story Points', 'Epic', 'Status', 'Acceptance Criteria', 'Created Date'];
        const csvContent = [
            headers.join(','),
            ...userStories.map(story => [
                `"${story.id}"`,
                `"${story.title}"`,
                `"As a ${story.userType}, I want ${story.action} so that ${story.benefit}."`,
                `"${story.priority}"`,
                story.storyPoints,
                `"${story.epic || ''}"`,
                `"${story.status}"`,
                `"${(story.acceptanceCriteria || []).join('; ')}"`,
                `"${story.createdDate.toLocaleString()}"`
            ].join(','))
        ].join('\n');
        
        const dataBlob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `user-stories-${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        URL.revokeObjectURL(url);
    }

    function saveToStorage() {
        localStorage.setItem('userStories', JSON.stringify(userStories));
        localStorage.setItem('storyIdCounter', storyIdCounter.toString());
    }

    function loadFromStorage() {
        try {
            const savedStories = localStorage.getItem('userStories');
            if (savedStories) {
                userStories = JSON.parse(savedStories).map(story => ({
                    ...story,
                    createdDate: new Date(story.createdDate)
                }));
            }
            const savedCounter = localStorage.getItem('storyIdCounter');
            if (savedCounter) {
                storyIdCounter = parseInt(savedCounter);
            }
        } catch(e) {
            console.error("Failed to load from localStorage", e);
        }
    }

    function saveAndRender() {
        saveToStorage();
        displayStories();
        updateStats();
        updateFilters();
    }
    
    function showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translate(-50%, -20px)';
        }, 50);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translate(-50%, 0)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadFromStorage();
        saveAndRender();
    });
</script>
</body>
</html>